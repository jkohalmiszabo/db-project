{% extends "base.html" %}

{% block content %}
<div class="container dbexplorer">
  <h1 class="mt-4 mb-4">Datenbank-Explorer</h1>

  <div class="row">
    <div class="col-md-4">
      <form method="POST" class="dbexplorer-form">
        <div class="form-group mb-3">
          <label for="table-search">Tabellen filtern</label>
          <input
            type="text"
            id="table-search"
            class="form-control"
            placeholder="Tabellennamen filtern…"
            oninput="filterTables()">
        </div>

        <div class="form-group mb-3">
          <label>Tabellen auswählen</label>
          <div class="dbexplorer-table-list border p-2" style="max-height: 250px; overflow-y: auto;">
            {% if all_tables %}
              {% for table in all_tables %}
                <label class="d-block table-option">
                  <input
                    type="checkbox"
                    name="tables"
                    value="{{ table }}"
                    {% if table in selected_tables %}checked{% endif %}>
                  {{ table }}
                </label>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0"><em>Keine Tabellen gefunden.</em></p>
            {% endif %}
          </div>
        </div>

        <div class="form-group mb-3">
          <label for="limit">Max. Zeilen pro Tabelle</label>
          <input
            type="number"
            id="limit"
            name="limit"
            class="form-control"
            min="1"
            max="1000"
            value="{{ limit }}">
          <small class="form-text text-muted">
            Begrenze die Anzahl Zeilen (1–1000).
          </small>
        </div>

        <button type="submit" class="btn btn-primary">
          Tabellen anzeigen
        </button>
      </form>
    </div>

    <div class="col-md-8">
      <div class="dbexplorer-results mt-3 mt-md-0">
        {% if results %}
          {% for table_name, rows in results.items() %}
            <div class="card mb-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ table_name }}</strong>
                <span class="badge bg-secondary">
                  {{ rows|length }} Zeile(n)
                </span>
              </div>
              <div class="card-body p-0">
                {% if rows %}
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered mb-0 db-table">
                      <thead class="table-light">
                        <tr>
                          {% for col in rows[0].keys() %}
                            <th scope="col">{{ col }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in rows %}
                          <tr>
                            {% for value in row.values() %}
                              <td>{{ value }}</td>
                            {% endfor %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="p-3">
                    <em>Keine Einträge in dieser Tabelle.</em>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">
            Wähle eine oder mehrere Tabellen links und klicke auf
            <strong>Tabellen anzeigen</strong>, um die Daten zu sehen.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function filterTables() {
    const q = document.getElementById('table-search').value.toLowerCase();
    const labels = document.querySelectorAll('.table-option');
    labels.forEach(label => {
      const text = label.textContent.toLowerCase();
      label.style.display = text.includes(q) ? '' : 'none';
    });
  }
</script>

<style>
  .dbexplorer .card-header {
    background-color: #f8f9fa;
  }
  .dbexplorer .db-table th,
  .dbexplorer .db-table td {
    font-size: 0.9rem;
    vertical-align: middle;
    white-space: nowrap;
  }
  .dbexplorer .db-table td {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
{% endblock %}
